<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="theme-color" content="#4f46e5" />
    <meta name="description" content="Class Connect - Group Chat" />
    <title>Class Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Inter', sans-serif;
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior-y: none;
      }
      h1, h2, h3, h4, h5, h6, .font-heading {
        font-family: 'Outfit', sans-serif;
      }
      .no-scrollbar::-webkit-scrollbar {
          display: none;
      }
      .no-scrollbar {
          -ms-overflow-style: none;
          scrollbar-width: none;
      }
      .glass {
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
      }
      /* Custom pattern for chat background */
      .bg-pattern {
        background-color: #f8fafc;
        background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
        background-size: 24px 24px;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
      }
      .pb-safe {
        padding-bottom: env(safe-area-inset-bottom);
      }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js",
    "firebase/firestore": "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "firebase/": "https://aistudiocdn.com/firebase@^12.6.0/"
  }
}
</script>
  </head>
  <body class="bg-slate-50 text-slate-900 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { initializeApp } from "firebase/app";
      import { getFirestore, collection, query, orderBy, onSnapshot, doc, setDoc, deleteDoc, updateDoc, addDoc, getDoc } from "firebase/firestore";
      import { getAuth, signInAnonymously } from "firebase/auth";

      // --- CONSTANTS ---
      const ADMIN_ID = "admin@jaineshseth";
      const ADMIN_NAME = "Jainesh Seth";
      const REACTION_EMOJIS = ["ðŸ‘", "â¤ï¸", "ðŸ˜‚", "ðŸ˜®", "ðŸ˜¢"];

      // --- FIREBASE CONFIG ---
      const firebaseConfig = {
        apiKey: "AIzaSyA2PUTtkpZNqwc5_KD1hOLOUww-vrtpY9c",
        authDomain: "taskmanager-9df11.firebaseapp.com",
        projectId: "taskmanager-9df11",
        storageBucket: "taskmanager-9df11.firebasestorage.app",
        messagingSenderId: "380357639423",
        appId: "1:380357639423:web:25da494ac1f139a48860ca",
        measurementId: "G-NKZQDGDDX1"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // --- COMPONENTS ---

      // InstallButton Component
      const InstallButton = () => {
        const [deferredPrompt, setDeferredPrompt] = useState(null);
        const [showInstallBtn, setShowInstallBtn] = useState(false);

        useEffect(() => {
          const handler = (e) => {
            e.preventDefault();
            setDeferredPrompt(e);
            setShowInstallBtn(true);
          };

          window.addEventListener('beforeinstallprompt', handler);

          if (window.matchMedia('(display-mode: standalone)').matches) {
            setShowInstallBtn(false);
          }

          return () => window.removeEventListener('beforeinstallprompt', handler);
        }, []);

        const handleInstallClick = async () => {
          if (!deferredPrompt) return;
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === 'accepted') {
            setShowInstallBtn(false);
            setDeferredPrompt(null);
          }
        };

        if (!showInstallBtn) return null;

        return (
          <div className="w-full bg-indigo-600 text-white p-3 flex items-center justify-between shadow-lg z-50 relative">
            <div className="flex items-center space-x-3 px-2">
              <div className="bg-white/20 p-1.5 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
              </div>
              <div className="text-sm font-medium">
                <p className="font-heading font-semibold">Install App</p>
                <p className="text-xs text-indigo-200">For the best experience</p>
              </div>
            </div>
            <button 
              onClick={handleInstallClick}
              className="bg-white text-indigo-600 px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wide hover:bg-indigo-50 transition-colors shadow-sm"
            >
              Install
            </button>
          </div>
        );
      };

      // AdminPanel Component
      const AdminPanel = ({ onClose, currentUser }) => {
        const [users, setUsers] = useState([]);
        const [loading, setLoading] = useState(true);
        const [userToDelete, setUserToDelete] = useState(null);
        const [newName, setNewName] = useState('');
        const [newUserId, setNewUserId] = useState('');
        const [isAdding, setIsAdding] = useState(false);

        useEffect(() => {
          const q = query(collection(db, "users"), orderBy("name", "asc"));
          const unsubscribe = onSnapshot(q, (snapshot) => {
            const userList = snapshot.docs.map(doc => doc.data());
            setUsers(userList);
            setLoading(false);
          });
          return () => unsubscribe();
        }, []);

        const handleAddUser = async (e) => {
          e.preventDefault();
          if (!newName.trim() || !newUserId.trim()) return;

          setIsAdding(true);
          try {
            const newUser = {
              name: newName.trim(),
              userId: newUserId.trim(),
              role: 'student',
              joinedAt: Date.now()
            };
            await setDoc(doc(db, "users", newUser.userId), newUser);
            setNewName('');
            setNewUserId('');
          } catch (error) {
            console.error("Error adding user:", error);
            alert("Failed to add user.");
          } finally {
            setIsAdding(false);
          }
        };

        const confirmDeleteUser = async () => {
          if (!userToDelete) return;
          try {
            await deleteDoc(doc(db, "users", userToDelete.userId));
            setUserToDelete(null);
          } catch (error) {
            console.error("Error removing user:", error);
            alert("Failed to remove user.");
          }
        };

        const handleRoleChange = async (userId, newRole) => {
          try {
            await updateDoc(doc(db, "users", userId), { role: newRole });
          } catch (error) {
            console.error("Error updating role:", error);
            alert("Failed to update role.");
          }
        };

        const canRemove = (targetUser) => {
          if (currentUser.role === 'admin') {
            return targetUser.userId !== currentUser.userId && targetUser.role !== 'admin';
          }
          if (currentUser.role === 'manager') {
            return targetUser.role === 'student';
          }
          return false;
        };

        return (
          <div className="fixed inset-0 z-50 flex justify-end">
            <div 
              className="absolute inset-0 bg-slate-900/30 backdrop-blur-sm transition-opacity" 
              onClick={onClose}
            />
            
            <div className="relative w-full max-w-md bg-white h-full shadow-2xl flex flex-col transform transition-transform duration-300 ease-in-out">
              <div className="px-6 py-5 border-b border-slate-100 flex items-center justify-between bg-white z-10">
                <div>
                  <h2 className="text-xl font-heading font-bold text-slate-800">Class Management</h2>
                  <p className="text-xs text-slate-500 font-medium">
                    {currentUser.role === 'admin' ? 'Manage Students & Managers' : 'Manage Students'}
                  </p>
                </div>
                <button 
                  onClick={onClose}
                  className="p-2 text-slate-400 hover:text-slate-800 bg-slate-50 rounded-full hover:bg-slate-100 transition-colors"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              <div className="flex-1 overflow-y-auto bg-slate-50 no-scrollbar">
                <div className="p-6 space-y-6">
                  
                  <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100/60">
                    <div className="flex items-center gap-2 mb-4 text-indigo-600">
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z" />
                      </svg>
                      <h3 className="text-sm font-bold uppercase tracking-wider">Register Student</h3>
                    </div>
                    
                    <form onSubmit={handleAddUser} className="space-y-3">
                      <div className="space-y-3">
                        <input
                          type="text"
                          placeholder="Student Name"
                          value={newName}
                          onChange={(e) => setNewName(e.target.value)}
                          className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all text-slate-800 font-medium placeholder:text-slate-400"
                        />
                        <input
                          type="text"
                          placeholder="Assign User ID"
                          value={newUserId}
                          onChange={(e) => setNewUserId(e.target.value)}
                          className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all text-slate-800 font-medium placeholder:text-slate-400"
                        />
                      </div>
                      <button
                        type="submit"
                        disabled={isAdding || !newName || !newUserId}
                        className="w-full py-3 bg-indigo-600 text-white rounded-xl text-sm font-bold hover:bg-indigo-700 active:scale-[0.98] disabled:opacity-50 transition-all shadow-lg shadow-indigo-200"
                      >
                        {isAdding ? 'Adding...' : 'Add to Class'}
                      </button>
                    </form>
                  </div>

                  <div className="space-y-3">
                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest px-1">Class Members ({users.length})</h3>
                    {loading ? (
                      <div className="flex justify-center py-10">
                        <div className="animate-spin rounded-full h-8 w-8 border-2 border-slate-200 border-t-indigo-600"></div>
                      </div>
                    ) : (
                      <div className="space-y-2">
                        {users.map((user) => (
                          <div key={user.userId} className="flex items-center justify-between p-3 bg-white rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow group">
                            <div className="flex items-center min-w-0 gap-3">
                              <div className={`w-10 h-10 flex-shrink-0 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-sm 
                                ${user.role === 'admin' ? 'bg-gradient-to-br from-purple-500 to-pink-500' : 
                                  user.role === 'manager' ? 'bg-gradient-to-br from-orange-400 to-amber-500' :
                                  'bg-gradient-to-br from-indigo-400 to-indigo-600'}`}>
                                {user.name.charAt(0).toUpperCase()}
                              </div>
                              <div className="overflow-hidden">
                                <p className="text-sm font-bold text-slate-800 truncate">{user.name}</p>
                                <p className="text-[10px] text-slate-400 font-mono font-medium truncate bg-slate-50 px-1.5 py-0.5 rounded mt-0.5 inline-block">
                                  {(currentUser.role === 'manager' && user.role === 'admin') ? 'HIDDEN' : user.userId}
                                </p>
                              </div>
                            </div>

                            <div className="flex items-center gap-2">
                              {user.role === 'admin' ? (
                                <span className="text-[10px] font-bold bg-purple-100 text-purple-600 px-2 py-1 rounded-md border border-purple-200">ADMIN</span>
                              ) : currentUser.role === 'admin' ? (
                                 <div className="relative">
                                   <select
                                      value={user.role}
                                      onChange={(e) => handleRoleChange(user.userId, e.target.value)}
                                      className={`text-[10px] font-bold uppercase py-1 pl-2 pr-6 rounded-md appearance-none cursor-pointer outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 border transition-colors
                                        ${user.role === 'manager' 
                                          ? 'bg-orange-50 text-orange-600 border-orange-100 hover:bg-orange-100' 
                                          : 'bg-indigo-50 text-indigo-600 border-indigo-100 hover:bg-indigo-100'}`}
                                   >
                                     <option value="student">STUDENT</option>
                                     <option value="manager">MANAGER</option>
                                   </select>
                                   <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-1 text-slate-500">
                                      <svg className="fill-current h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                   </div>
                                 </div>
                              ) : user.role === 'manager' ? (
                                 <span className="text-[10px] font-bold bg-orange-100 text-orange-600 px-2 py-1 rounded-md border border-orange-200">MANAGER</span>
                              ) : null}

                               {canRemove(user) && (
                                 <button
                                  onClick={() => setUserToDelete({ userId: user.userId, name: user.name })}
                                  className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                                  title="Remove User"
                                >
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                  </svg>
                                </button>
                               )}
                            </div>
                          </div>
                        ))}
                        {!loading && users.length === 0 && (
                          <div className="text-center py-8 border-2 border-dashed border-slate-200 rounded-xl">
                            <p className="text-slate-400 text-sm">No members yet.</p>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {userToDelete && (
              <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setUserToDelete(null)} />
                <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm relative z-10 animate-[fadeIn_0.2s_ease-out]">
                  <div className="flex flex-col items-center text-center">
                    <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-4">
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                      </svg>
                    </div>
                    <h3 className="text-lg font-bold text-slate-800 mb-2">Remove Member?</h3>
                    <p className="text-sm text-slate-500 mb-6">
                      Are you sure you want to remove <strong className="text-slate-800">{userToDelete.name}</strong>? They won't be able to access the chat.
                    </p>
                    <div className="flex w-full gap-3">
                      <button
                        onClick={() => setUserToDelete(null)}
                        className="flex-1 py-2.5 px-4 bg-slate-100 text-slate-700 font-semibold rounded-xl hover:bg-slate-200 transition-colors"
                      >
                        Cancel
                      </button>
                      <button
                        onClick={confirmDeleteUser}
                        className="flex-1 py-2.5 px-4 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 shadow-lg shadow-red-200 transition-all"
                      >
                        Remove
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      };

      // Chat Component
      const Chat = ({ currentUser, onLogout }) => {
        const [messages, setMessages] = useState([]);
        const [newMessage, setNewMessage] = useState('');
        const [showAdminPanel, setShowAdminPanel] = useState(false);
        const [messageToDelete, setMessageToDelete] = useState(null);
        const messagesEndRef = useRef(null);

        useEffect(() => {
          const q = query(collection(db, "messages"), orderBy("timestamp", "asc"));
          const unsubscribe = onSnapshot(q, (snapshot) => {
            const msgs = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            setMessages(msgs);
          });
          return () => unsubscribe();
        }, []);

        useEffect(() => {
          messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        }, [messages]);

        const handleSendMessage = async (e) => {
          e.preventDefault();
          if (!newMessage.trim()) return;

          try {
            await addDoc(collection(db, "messages"), {
              text: newMessage,
              senderId: currentUser.userId,
              senderName: currentUser.name,
              timestamp: Date.now(),
              type: 'text',
              reactions: {} // Initialize with empty reactions
            });
            setNewMessage('');
          } catch (error) {
            console.error("Error sending message", error);
          }
        };

        const handleReaction = async (messageId, emoji) => {
          try {
            const msgRef = doc(db, "messages", messageId);
            const msgSnap = await getDoc(msgRef);
            
            if (msgSnap.exists()) {
              const data = msgSnap.data();
              const currentReactions = data.reactions || {};
              const emojiReactions = currentReactions[emoji] || [];
              
              let updatedEmojiReactions;
              if (emojiReactions.includes(currentUser.userId)) {
                // Remove reaction
                updatedEmojiReactions = emojiReactions.filter(id => id !== currentUser.userId);
              } else {
                // Add reaction
                updatedEmojiReactions = [...emojiReactions, currentUser.userId];
              }
              
              // We use dot notation to update specific map field in Firestore
              // If the array becomes empty, we could remove the key, but keeping empty array is fine
              await updateDoc(msgRef, {
                [`reactions.${emoji}`]: updatedEmojiReactions
              });
            }
          } catch (err) {
            console.error("Reaction error", err);
          }
        };

        const confirmDeleteMessage = async () => {
          if (!messageToDelete) return;
          try {
            await deleteDoc(doc(db, "messages", messageToDelete));
            setMessageToDelete(null);
          } catch (error) {
            console.error("Error deleting message", error);
          }
        };

        const formatTime = (timestamp) => {
          return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };

        const canManage = currentUser.role === 'admin' || currentUser.role === 'manager';

        return (
          <div className="flex flex-col h-full bg-pattern relative">
            <header className="glass px-4 py-3 z-30 flex items-center justify-between sticky top-0 shadow-sm">
              <div className="flex items-center space-x-3">
                <div className="relative">
                   <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg shadow-indigo-500/30 transform rotate-3">
                     CC
                   </div>
                   <div className="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
                </div>
                <div>
                  <h2 className="font-heading font-bold text-slate-800 text-lg leading-tight">Class Room</h2>
                  <div className="flex items-center gap-1.5">
                    <p className="text-xs text-slate-500 font-medium truncate max-w-[120px]">
                      {currentUser.name}
                    </p>
                    {currentUser.role === 'admin' && (
                      <span className="text-[9px] font-bold uppercase bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded border border-purple-200">Admin</span>
                    )}
                    {currentUser.role === 'manager' && (
                      <span className="text-[9px] font-bold uppercase bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded border border-orange-200">Manager</span>
                    )}
                  </div>
                </div>
              </div>
              
              <div className="flex items-center gap-2">
                {canManage && (
                  <button
                    onClick={() => setShowAdminPanel(true)}
                    className="p-2.5 text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-full transition-all active:scale-95"
                    title="Class Management"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                  </button>
                )}
                <button
                  onClick={onLogout}
                  className="p-2.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-all active:scale-95"
                  title="Logout"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                  </svg>
                </button>
              </div>
            </header>

            <div className="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-24">
              {messages.map((msg) => {
                const isMe = msg.senderId === currentUser.userId;
                const canDelete = canManage || isMe;
                
                // Process Reactions
                const reactions = msg.reactions || {};
                const reactionKeys = Object.keys(reactions).filter(k => reactions[k] && reactions[k].length > 0);

                return (
                  <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'} animate-[fadeIn_0.3s_ease-out]`}>
                    <div 
                      className={`max-w-[85%] sm:max-w-[70%] relative group transition-all ${
                        isMe 
                          ? 'items-end flex flex-col' 
                          : 'items-start flex flex-col'
                      }`}
                    >
                      {/* Reaction Picker - Shows on Group Hover */}
                      <div className={`absolute -top-8 ${isMe ? 'right-0' : 'left-0'} bg-white shadow-lg rounded-full px-2 py-1 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-20 pointer-events-none group-hover:pointer-events-auto border border-slate-100`}>
                          {REACTION_EMOJIS.map(emoji => (
                              <button
                                  key={emoji}
                                  onClick={() => handleReaction(msg.id, emoji)}
                                  className="hover:scale-125 transition-transform p-1 text-lg leading-none select-none"
                              >
                                  {emoji}
                              </button>
                          ))}
                      </div>

                      {!isMe && (
                        <span className="text-[10px] font-bold text-slate-500 ml-2 mb-1">{msg.senderName}</span>
                      )}
                      
                      <div className={`px-4 py-2.5 shadow-sm text-[15px] leading-relaxed break-words whitespace-pre-wrap ${
                        isMe
                          ? 'bg-indigo-600 text-white rounded-2xl rounded-tr-sm'
                          : 'bg-white text-slate-800 rounded-2xl rounded-tl-sm border border-slate-100'
                      }`}>
                        {msg.text}
                      </div>
                      
                      <div className="flex items-center gap-2 mt-1">
                          <span className={`text-[10px] font-medium opacity-60 px-1 ${isMe ? 'text-indigo-900' : 'text-slate-400'}`}>
                            {formatTime(msg.timestamp)}
                          </span>
                          
                          {/* Reaction Display */}
                          {reactionKeys.length > 0 && (
                            <div className="flex flex-wrap gap-1">
                                {reactionKeys.map(emoji => {
                                    const count = reactions[emoji].length;
                                    const iReacted = reactions[emoji].includes(currentUser.userId);
                                    return (
                                        <button
                                            key={emoji}
                                            onClick={() => handleReaction(msg.id, emoji)}
                                            className={`flex items-center gap-1 px-1.5 py-0.5 rounded-full text-[10px] font-bold border transition-colors shadow-sm ${
                                                iReacted 
                                                ? 'bg-indigo-50 border-indigo-200 text-indigo-600' 
                                                : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'
                                            }`}
                                        >
                                            <span>{emoji}</span>
                                            <span>{count}</span>
                                        </button>
                                    );
                                })}
                            </div>
                          )}
                      </div>

                      {canDelete && (
                        <button
                          onClick={() => setMessageToDelete(msg.id)}
                          className={`absolute top-1/2 -translate-y-1/2 p-1.5 bg-white rounded-full shadow-md text-red-500 opacity-0 group-hover:opacity-100 transition-all duration-200 z-10 hover:scale-110 border border-slate-100 ${
                              isMe ? '-left-10' : '-right-10'
                          }`}
                          title="Delete Message"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                        </button>
                      )}
                    </div>
                  </div>
                );
              })}
              <div ref={messagesEndRef} />
            </div>

            <div className="absolute bottom-0 left-0 right-0 p-3 pb-safe z-20">
               <div className="glass-card rounded-[2rem] p-1.5 pl-4 shadow-xl shadow-indigo-900/5">
                  <form onSubmit={handleSendMessage} className="flex items-end gap-2">
                      <textarea
                        value={newMessage}
                        onChange={(e) => setNewMessage(e.target.value)}
                        placeholder="Type your message..."
                        rows={1}
                        className="flex-1 bg-transparent py-3 max-h-32 text-slate-800 placeholder:text-slate-400 focus:outline-none resize-none no-scrollbar text-base font-medium"
                        onKeyDown={(e) => {
                          if(e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            handleSendMessage(e);
                          }
                        }}
                      />
                      <button
                        type="submit"
                        disabled={!newMessage.trim()}
                        className="p-3 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-95 shadow-lg shadow-indigo-200"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 transform rotate-90 translate-x-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                      </button>
                  </form>
               </div>
            </div>

            {showAdminPanel && (
              <AdminPanel currentUser={currentUser} onClose={() => setShowAdminPanel(false)} />
            )}

            {messageToDelete && (
              <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setMessageToDelete(null)} />
                <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm relative z-10 animate-[fadeIn_0.2s_ease-out]">
                  <h3 className="text-lg font-bold text-slate-800 mb-2">Delete Message?</h3>
                  <p className="text-sm text-slate-500 mb-6">
                    This will remove the message for everyone in the chat immediately.
                  </p>
                  <div className="flex w-full gap-3">
                    <button
                      onClick={() => setMessageToDelete(null)}
                      className="flex-1 py-2.5 px-4 bg-slate-100 text-slate-700 font-semibold rounded-xl hover:bg-slate-200 transition-colors"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={confirmDeleteMessage}
                      className="flex-1 py-2.5 px-4 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 shadow-lg shadow-red-200 transition-all"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      };

      // Login Component
      const Login = ({ onLogin }) => {
        const [userId, setUserId] = useState('');
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [error, setError] = useState('');

        const handleSubmit = async (e) => {
          e.preventDefault();
          if (!userId.trim()) {
            setError("Please enter a User ID.");
            return;
          }

          setIsSubmitting(true);
          setError('');
          const cleanId = userId.trim();

          try {
            await signInAnonymously(auth);

            let userToLogin;
            
            if (cleanId === ADMIN_ID) {
              userToLogin = {
                userId: ADMIN_ID,
                name: ADMIN_NAME,
                role: 'admin',
                joinedAt: Date.now()
              };
              await setDoc(doc(db, "users", ADMIN_ID), userToLogin, { merge: true });
            } else {
              const userDoc = await getDoc(doc(db, "users", cleanId));
              if (userDoc.exists()) {
                userToLogin = userDoc.data();
              } else {
                throw new Error("User ID not found. Ask the Admin to add you.");
              }
            }

            if (userToLogin) {
              onLogin(userToLogin);
            }
          } catch (err) {
            console.error("Login error:", err);
            if (err.message) {
              setError(err.message);
            } else if (err.code === 'permission-denied') {
               setError("Access denied. Check connection.");
            } else {
               setError("Failed to login. Try again.");
            }
          } finally {
            setIsSubmitting(false);
          }
        };

        return (
          <div className="flex flex-col items-center justify-center h-full w-full px-6 bg-slate-50 relative overflow-hidden">
            <div className="absolute top-[-20%] right-[-10%] w-[300px] h-[300px] bg-indigo-200/40 rounded-full blur-3xl"></div>
            <div className="absolute bottom-[-10%] left-[-10%] w-[250px] h-[250px] bg-purple-200/40 rounded-full blur-3xl"></div>

            <div className="w-full max-w-sm glass-card p-8 rounded-[2.5rem] relative z-10 animate-[fadeIn_0.5s_ease-out]">
              <div className="text-center mb-8">
                <div className="w-20 h-20 bg-gradient-to-tr from-indigo-600 to-purple-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl shadow-indigo-500/20 transform -rotate-6 hover:rotate-0 transition-transform duration-500">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                  </svg>
                </div>
                <h1 className="text-3xl font-heading font-bold text-slate-900 tracking-tight">Class Connect</h1>
                <p className="text-slate-500 text-sm mt-2">Enter your ID to join the room</p>
              </div>

              <form onSubmit={handleSubmit} className="space-y-6">
                <div className="space-y-1">
                  <label htmlFor="userId" className="block text-xs font-bold text-indigo-900/60 uppercase tracking-wider ml-1">
                    User ID
                  </label>
                  <div className="relative group">
                    <input
                      id="userId"
                      type="text"
                      value={userId}
                      onChange={(e) => setUserId(e.target.value)}
                      className="w-full px-5 py-4 bg-slate-50/50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 focus:bg-white outline-none transition-all font-semibold text-slate-800 placeholder:text-slate-400"
                      placeholder="e.g. 1024"
                      autoComplete="off"
                      required
                    />
                    <div className="absolute right-4 top-4 text-slate-400 group-focus-within:text-indigo-500 transition-colors pointer-events-none">
                       <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                         <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                       </svg>
                    </div>
                  </div>
                </div>

                {error && (
                  <div className="flex items-start gap-3 text-red-600 text-sm bg-red-50/80 p-4 rounded-xl border border-red-100 animate-[fadeIn_0.3s_ease-out]">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                      <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                    </svg>
                    <span className="font-medium">{error}</span>
                  </div>
                )}

                <button
                  type="submit"
                  disabled={isSubmitting}
                  className="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold text-lg rounded-2xl hover:shadow-xl hover:shadow-indigo-600/20 active:scale-[0.98] transition-all disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center gap-2 mt-4"
                >
                  {isSubmitting ? (
                    <>
                      <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      <span>Verifying...</span>
                    </>
                  ) : (
                    <>
                      <span>Enter Class</span>
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" />
                      </svg>
                    </>
                  )}
                </button>
              </form>
            </div>
            <p className="mt-8 text-xs text-slate-400 font-medium z-10">Â© 2024 Class Connect</p>
          </div>
        );
      };

      // App Component
      const App = () => {
        const [user, setUser] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
          const initAuth = async () => {
            const storedUser = localStorage.getItem('class_chat_user_v5');
            
            if (storedUser) {
              try {
                const parsedUser = JSON.parse(storedUser);
                if (!parsedUser.userId) {
                   throw new Error("Invalid user format");
                }
                if (!auth.currentUser) {
                  await signInAnonymously(auth);
                }
                setUser(parsedUser);
              } catch (e) {
                console.error("Failed to restore session", e);
                localStorage.removeItem('class_chat_user_v5');
              }
            }
            setLoading(false);
          };

          initAuth();
        }, []);

        // Real-time listener for role updates
        useEffect(() => {
          if (!user?.userId) return;

          const unsubscribe = onSnapshot(doc(db, "users", user.userId), (snapshot) => {
            if (snapshot.exists()) {
              const userData = snapshot.data();
              // If role has changed in the database, update local state
              if (userData.role !== user.role) {
                const updatedUser = { ...user, role: userData.role };
                setUser(updatedUser);
                localStorage.setItem('class_chat_user_v5', JSON.stringify(updatedUser));
              }
            }
          });

          return () => unsubscribe();
        }, [user?.userId, user?.role]);

        const handleLogin = (newUser) => {
          setUser(newUser);
          localStorage.setItem('class_chat_user_v5', JSON.stringify(newUser));
        };

        const handleLogout = () => {
          setUser(null);
          localStorage.removeItem('class_chat_user_v5');
        };

        if (loading) {
          return (
            <div className="flex items-center justify-center h-[100dvh] w-full bg-slate-50">
              <div className="animate-spin rounded-full h-12 w-12 border-2 border-indigo-100 border-t-indigo-600"></div>
            </div>
          );
        }

        return (
          <div className="h-[100dvh] w-full max-w-md mx-auto bg-white shadow-2xl relative overflow-hidden flex flex-col">
            <InstallButton />
            {user ? (
              <Chat currentUser={user} onLogout={handleLogout} />
            ) : (
              <Login onLogin={handleLogin} />
            )}
          </div>
        );
      };

      // Main Entry Point
      const rootElement = document.getElementById('root');
      if (rootElement) {
        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
      }
    </script>
  </body>
</html>
